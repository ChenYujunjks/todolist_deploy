### 1 为何会崩：版本错配 + 旧镜像缺陷

1. **PostgreSQL 的硬性规则**

   - 数据目录里有一个 `PG_VERSION` 文件（以及控制文件 header）。
   - 当 **服务器版本 < 数据目录版本** 时，`postgres` 会立即退出并抛出

     ```
     FATAL:  database files are incompatible with server
     DETAIL: The data directory was initialized by PostgreSQL version 17, which is not compatible with this version 15.8.
     ```

   - 这是为了保护底层 WAL/元数据格式；旧版本永远不能直接读取新版本的数据目录。

2. **Supabase CLI 的默认行为**

   - 本地第一次 `supabase start` 时，它会

     1. 把 `supabase/postgres:15.*` 镜像 tag 写进 `supabase/.temp/postgres-version`；
     2. 用这个镜像起容器，在卷 `supabase_db_…` 里初始化 **PG 15 数据目录**。

   - 之后如果你执行 `supabase upgrade`, `supabase link` 或手动改 tag，也可以把镜像升到 17，卷也随之被 **initdb -U\*\*\*\*升级**。

3. **出问题的场景**

   - 你曾经用 PG 17 镜像启动过，卷已经“升级”；
   - 但 `.temp/postgres-version` 仍写着 **15.8.1.085**（或 CLI 回退了默认值）；
   - CLI 重启时拉回了 15 镜像 → 版本错配 → 容器健康检查失败、无限重启。
   - 旧的 17.4.≤ `037` 镜像还带着 “自托管检测” 脚本，如果找不到 `init-scripts/99-roles.sql` 会让健康检查直接判失败，即使版本正确也可能卡住；这是 5 月 30 日 hot-fix 修掉的。

### 2 ️⃣ “echo 17.4.1.010 > .temp/postgres-version” 为什么立刻就好

1. **CLI 启动逻辑**

   ```text
   if [ -f .temp/postgres-version ]; then
       IMAGE_TAG=$(cat .temp/postgres-version)
   else
       IMAGE_TAG=15.x.y.zzz
   fi
   docker compose pull supabase/postgres:$IMAGE_TAG
   ```

   - 你把文件内容改成 `17.4.1.010` → CLI 改拉 **17.4.1.010** 镜像。
   - 该 tag ≥ 2025-05-30，已带 hot-fix，启动脚本不会因 `99-roles.sql` 缺失而报错。

2. **PG 17 ↔ PG 17**

   - 容器里运行的 `postgres --version` 与数据目录中的 `PG_VERSION` 同为 `17`，兼容检查通过。
   - 健康检查脚本收到 **“server is ready to accept connections”** 的 OK 信号 → container health = healthy。
   - CLI 检测全部服务 healthy 后打印出你看到的端口与 JWT 信息，本地栈恢复正常。

### 3 ️⃣ 关键点总结

| 关键环节                                                | 作用                                       | 为什么必须这样做        |
| ------------------------------------------------------- | ------------------------------------------ | ----------------------- |
| **同步镜像版本**                                        | 保证 `postgres` 可读取卷                   | PG 不允许回退读取       |
| **使用 hot-fix 之后的 tag**                             | 避免缺失 `99-roles.sql` 再次触发 unhealthy | bug 已在 17.4.1.x 修复  |
| **`supabase link` 或手工编辑 `.temp/postgres-version`** | 控制 CLI 拉取镜像的版本                    | `.temp` 会覆盖 CLI 默认 |

以后只要记住：**卷里已是 PG17，就永远别让 CLI 再拉 PG15 镜像**；你可以：

1. `supabase link`（同步云端 project 的 service 版本）；
2. 或在 `.temp/postgres-version` 写入固定 tag；
3. 或升级到 CLI 2.27.0+，它已改进版本检测逻辑，会在发现卷版本较新时给出交互式提示，而不会静默拉旧镜像。

这样就不会再掉进同一个坑了 🚀
